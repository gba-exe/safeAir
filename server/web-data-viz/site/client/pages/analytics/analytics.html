<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="../../assets/logoClaro.jpeg" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="analytics.css">
    <link rel="stylesheet" href="../../style/style.css" />
    <link rel="stylesheet" href="../navbarFooter/navbarDashboard.css">
    <title>Analytics</title>
</head>

<body>
    <script src="../../assets/components/headerDashboard.js"></script>
    <div id="divDashboard">
        <div class="divContent">

            <div class="divLogo">
                <img src="../../assets/logos/logoSemFundoMaior.png">
            </div>

            <div class="divMetricas">
                <div class="divMetricaEspecifica">
                    <h1>Métricas utilizadas para temperatura</h1>
                    <img src="../../assets/analyticsTemperatura.png" alt="">
                    <div class="divMetricasBolinhas">
                        <div>
                            <h4>Crítico</h4>
                            <h4 class="critico">14ºC</h4>
                        </div>
                        <div>
                            <h4>Emergência</h4>
                            <h4 class="emergencia">16ºC</h4>
                        </div>
                        <div>
                            <h4>Alerta</h4>
                            <h4 class="alerta">18ºC</h4>
                        </div>
                        <div>
                            <h4>Ideal</h4>
                            <h4 class="ideal">20-23ºC</h4>
                        </div>
                        <div>
                            <h4>Alerta</h4>
                            <h4 class="alerta">25ºC</h4>
                        </div>
                        <div>
                            <h4>Emergência</h4>
                            <h4 class="emergencia">27ºC</h4>
                        </div>
                        <div>
                            <h4>Crítico</h4>
                            <h4 class="critico">30ºC</h4>
                        </div>
                    </div>
                </div>
                <div class="divMetricaEspecifica">
                    <h1>Métricas utilizadas para umidade</h1>
                    <img src="../../assets/analyticsUmidade.png" alt="">
                    <div class="divMetricasBolinhas">
                        <div>
                            <h4>Crítico</h4>
                            <h4 class="critico">25%</h4>
                        </div>
                        <div>
                            <h4>Emergência</h4>
                            <h4 class="emergencia">30%</h4>
                        </div>
                        <div>
                            <h4>Alerta</h4>
                            <h4 class="alerta">35%</h4>
                        </div>
                        <div>
                            <h4>Ideal</h4>
                            <h4 class="ideal">40-50%</h4>
                        </div>
                        <div>
                            <h4>Alerta</h4>
                            <h4 class="alerta">55%</h4>
                        </div>
                        <div>
                            <h4>Emergência</h4>
                            <h4 class="emergencia">60%</h4>
                        </div>
                        <div>
                            <h4>Crítico</h4>
                            <h4 class="critico">75%</h4>
                        </div>
                    </div>
                </div>
            </div>

            <div class="divSelect">
                <select id="selectEndereco" onchange="plotarGrafico()">
                </select>
                <select id="selectSala" onchange="plotarGrafico()">
                </select>
            </div>

            <div class="divGraficosGeral">
                <div id="h1RelatorioSala"></div>
                <div class="divTodosGraficos">
                    <div class="divGrafico">
                        <div class="divTemperaturaGrafico">
                            <canvas style="width : 100%;" id="rosquinhaTemperatura"></canvas>
                        </div>
                        <div class="divLegenda">
                            <label for="">
                                <img src="../../assets/bolinhaVerde.png" alt="">
                                <div id="pIdealTemp"></div>
                            </label>
                            <label for="">
                                <img src="../../assets/bolinhaAmarela.png" alt="">
                                <div id="pAlertaTemp"></div>
                            </label>
                            <label for="">
                                <img src="../../assets/bolinhaLaranja.png" alt="">
                                <div id="pEmergenciaTemp"></div>
                            </label>
                            <label for="">
                                <img src="../../assets/bolinhaVermelha.png" alt="">
                                <div id="pCriticoTemp"></div>
                            </label>
                        </div>
                    </div>
                    <div class="divGrafico">
                        <div class="divUmidadeGrafico">
                            <canvas style="width : 100%;" id="rosquinhaUmidade"></canvas>
                        </div>
                        <div class="divLegenda">
                            <label for="">
                                <img src="../../assets/bolinhaVerde.png" alt="">
                                <div id="pIdealUmid"></div>
                            </label>
                            <label for="">
                                <img src="../../assets/bolinhaAmarela.png" alt="">
                                <div id="pAlertaUmid"></div>
                            </label>
                            <label for="">
                                <img src="../../assets/bolinhaLaranja.png" alt="">
                                <div id="pEmergenciaUmid"></div>
                            </label>
                            <label for="">
                                <img src="../../assets/bolinhaVermelha.png" alt="">
                                <div id="pCriticoUmid"></div>
                            </label>
                        </div>
                    </div>
                </div>
                <div id="divRegistros">
                    <div class="divRegistroTempUmi">
                        <h1>Registro de Temperatura</h1>
                        <div class="divDados">
                            <div class="data" id="dataTemp">
                                <h1>DATA:</h1>
                            </div>
                            <div class="data" id="dadoTemp">
                                <h1>DADOS:</h1>
                            </div>
                        </div>
                    </div>
                    <div class="divRegistroTempUmi">
                        <h1>Registro de Umidade</h1>
                        <div class="divDados">
                            <div class="data" id="dataUmi">
                                <h1>DATA:</h1>
                            </div>
                            <div class="data" id="dadoUmi">
                                <h1>DADOS:</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="analytics.js"></script>
<script>
    const rosquinha = document.getElementById("rosquinhaTemperatura");

    const rosquinha3 = new Chart(rosquinha, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [temperaturaIdeal, temperaturaAlerta, temperaturaEmergencia, temperaturaCritica],
                backgroundColor: [
                    'rgb(101,163,13)', 'rgb(207,188,15)', 'rgb(207,119,15)', 'rgb(194,65,12)'
                ],
                borderColor: [
                    'rgb(101,163,13)', 'rgb(207,188,15)', 'rgb(207,119,15)', 'rgb(194,65,12)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            cutoutPercentage: 100,
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 18
                        }
                    }
                }
            }

        }
    });
    // rosquinha1.data.datasets[0].data = [umidadeIdeal, umidadeAlerta, umidadeEmergencia, umidadeCritica];

    const rosquinha1 = document.getElementById('rosquinhaUmidade');
    const rosquinha2 = new Chart(rosquinha1, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [],
                backgroundColor: [
                    'rgb(101,163,13)', 'rgb(207,188,15)', 'rgb(207,119,15)', 'rgb(194,65,12)'
                ],
                borderColor: [
                    'rgb(101,163,13)', 'rgb(207,188,15)', 'rgb(207,119,15)', 'rgb(194,65,12)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            cutoutPercentage: 100,
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: 18
                        }
                    }
                }
            }

        }
    });

    var fkEmpresa = sessionStorage.EMPRESA_USUARIO;

    var vtCaptura = [];
    var vtSalas = [];
    var vtId = [];
    var fkEmpresaVar = fkEmpresa;


    captarSalas();
    captarEndereco();

    function captarSalas() {
        if (fkEmpresaVar == '') {
            alert('Não encontrei esta uma empresa com este id');
            return false;
        }
        else {
            console.log("idEmpresa: ", fkEmpresaVar);

            fetch("/usuarios/captarSalas", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fkEmpresaServer: fkEmpresaVar
                })
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO captarSalas()!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));

                        vtCaptura = json;
                        console.log(vtCaptura.length)

                        for (let i = 0; i < vtCaptura.length; i++) {
                            let pushNome = vtCaptura[i].nomeSala;
                            let pushId = vtCaptura[i].idSala;
                            vtSalas.push(pushNome);
                            vtId.push(pushId);
                        }
                        console.log(vtSalas.length)
                        for (let i = 0; i < vtSalas.length; i++) {
                            selectSala.innerHTML += `<option value='${vtId[i]}'>${vtSalas[i]}</option>`
                        }
                    });

                } else {
                    alert("A captura não funcionou")
                    console.log("Houve um erro ao tentar realizar a captura");
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }
    }

    var vtCapturaEndereco = [];
    var vtEndereco = [];
    var vtNumeroEndereco = [];
    var vtIdEndereco = [];
    var vtEnderecoCidade = [];
    var vtEnderecoEstado = [];


    function captarEndereco() {
        if (fkEmpresaVar == '') {
            alert('Não encontrei esta uma empresa com este id');
            return false;
        }
        else {
            console.log("idEmpresa: ", fkEmpresaVar);

            fetch("/usuarios/captarEndereco", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fkEmpresaServer: fkEmpresaVar
                })
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO captarSalas()!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));

                        vtCapturaEndereco = json;
                        console.log(vtCapturaEndereco.length)

                        for (let i = 0; i < vtCapturaEndereco.length; i++) {
                            let pushRua = vtCapturaEndereco[i].rua;
                            let pushNumero = vtCapturaEndereco[i].numero;
                            let pushEstado = vtCapturaEndereco[i].estado;
                            let pushCidade = vtCapturaEndereco[i].cidade;
                            let pushIdEndereco = vtCapturaEndereco[i].idEndereco;
                            vtEndereco.push(pushRua);
                            vtNumeroEndereco.push(pushNumero);
                            vtEnderecoCidade.push(pushCidade);
                            vtEnderecoEstado.push(pushEstado);
                            vtIdEndereco.push(pushIdEndereco);

                        }
                        console.log(vtEndereco.length)
                        for (let i = 0; i < vtEndereco.length; i++) {
                            selectEndereco.innerHTML += `<option value='${vtIdEndereco[i]}'>${vtEnderecoEstado[i]} - ${vtEndereco[i]}, ${vtNumeroEndereco[i]}</option>`
                        }
                    });

                } else {
                    alert("A captura não funcionou")
                    console.log("Houve um erro ao tentar realizar a captura de endereco");
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }
    }
    var vtCapturaValores = [];

    var temperaturaIdeal = 0;
    var temperaturaAlerta = 0;
    var temperaturaEmergencia = 0;
    var temperaturaCritica = 0;
    var somaQuantidadeTemperatura = 0;

    var umidadeIdeal = 0;
    var umidadeAlerta = 0;
    var umidadeEmergencia = 0;
    var umidadeCritica = 0;
    var somaQuantidadeUmidade = 0;

    setTimeout(() => {
        plotarGrafico();
    }, 800)

    function plotarGrafico() {
        pIdealTemp.innerHTML = '';
        pAlertaTemp.innerHTML = '';
        pEmergenciaTemp.innerHTML = '';
        pCriticoTemp.innerHTML = '';
        pIdealUmid.innerHTML = '';
        pAlertaUmid.innerHTML = '';
        pEmergenciaUmid.innerHTML = '';
        pCriticoUmid.innerHTML = '';
        var fkSalaVar = Number(selectSala.value);
        var fkEnderecoVar = Number(selectEndereco.value);
        fkEmpresaVar;
        var data = new Date();
        var mesAtual = String(data.getMonth()).padStart(2, '0');

        var mesAnteriorVar = mesAtual;



        if (fkEnderecoVar == '') {
            alert('Por algum motivo esta opção não está registrada, contate nossa equipe');
            return false;
        }
        else if (fkSalaVar == '') {
            alert('Por algum motivo esta opção não está registrada, contate nossa equipe');
            return false;
        }
        else if (fkEmpresaVar == '') {
            alert('Por algum motivo esta opção não está registrada, contate nossa equipe');
            return false;
        }
        else if (mesAnteriorVar == '') {
            alert('Por algum motivo esta opção não está registrada, contate nossa equipe');
            return false;
        }
        else {
            console.log("idEmpresa: ", fkEmpresaVar,
                "idEndereco: ", fkEnderecoVar,
                'idSala: ', fkSalaVar,
                'mesAnterior: ', mesAnteriorVar);

            fetch("/usuarios/atualizarAnalytics", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    fkSalaServer: fkSalaVar,
                    fkEnderecoServer: fkEnderecoVar,
                    fkEmpresaServer: fkEmpresaVar,
                    mesAnteriorServer: mesAnteriorVar
                })
            }).then(function (resposta) {
                console.log("ESTOU NO THEN DO atualizarAnalytics()!")

                if (resposta.ok) {
                    console.log(resposta);

                    resposta.json().then(json => {
                        console.log(json);
                        console.log(JSON.stringify(json));

                        vtCapturaValores = json;
                        console.log(vtCapturaValores)

                        temperaturaIdeal = 0;
                        temperaturaAlerta = 0;
                        temperaturaEmergencia = 0;
                        temperaturaCritica = 0;
                        umidadeIdeal = 0;
                        umidadeAlerta = 0;
                        umidadeEmergencia = 0;
                        umidadeCritica = 0;

                        dataTemp.innerHTML = '<h1>DATA:</h1>'
                        dataUmi.innerHTML = '<h1>DATA:</h1>'
                        dadoTemp.innerHTML = '<h1>DADOS:</h1>'
                        dadoUmi.innerHTML = '<h1>DADOS:</h1>'
                        h1RelatorioSala.innerHTML = `<h1>Com base nos registros do último mês, a sala ${vtSalas[fkSalaVar-1]} esteve nos seguintes estados:</h1>`

                        if (vtCapturaValores.length == 0) {
                            console.log("Nenhum registro encontrado");
                        }

                        for (let i = 0; i < vtCapturaValores.length; i++) {
                            let data = vtCapturaValores[i].data;
                            let dataFormat1 = data.slice(0, 10);
                            let ano = dataFormat1.slice(0, 4);
                            let mes = dataFormat1.slice(5, 7);
                            let dia = dataFormat1.slice(8, 10);
                            let dataFormat = dia + '/' + mes + '/' + ano;
                            dataTemp.innerHTML += `<p>${dataFormat}</p>`;
                            dadoTemp.innerHTML += `<p>${(vtCapturaValores[i].mediaTemp).slice(0, 5)}°C</p>`;
                            dataUmi.innerHTML += `<p>${dataFormat}</p>`;
                            dadoUmi.innerHTML += `<p>${(vtCapturaValores[i].mediaUmi).slice(0, 5)}</p>`;

                            let temperaturaAtual = vtCapturaValores[i].mediaTemp;
                            let umidadeAtual = vtCapturaValores[i].mediaUmi;

                            if (temperaturaAtual <= 14 || temperaturaAtual >= 30) {
                                temperaturaCritica++;
                                somaQuantidadeTemperatura++;
                            }
                            else if (temperaturaAtual <= 16 || temperaturaAtual >= 27) {
                                temperaturaEmergencia++;
                                somaQuantidadeTemperatura++;
                            }
                            else if (temperaturaAtual <= 18 || temperaturaAtual >= 25) {
                                temperaturaAlerta++;
                                somaQuantidadeTemperatura++;
                            }
                            else if (temperaturaAtual > 18 || temperaturaAtual < 25) {
                                temperaturaIdeal++;
                                somaQuantidadeTemperatura++;
                            }

                            if (umidadeAtual <= 25 || umidadeAtual >= 75) {
                                umidadeCritica++;
                                somaQuantidadeUmidade++;
                            }
                            else if (umidadeAtual <= 30 || umidadeAtual >= 60) {
                                umidadeEmergencia++;
                                somaQuantidadeUmidade++;
                            }
                            else if (umidadeAtual <= 35 || umidadeAtual >= 55) {
                                umidadeAlerta++;
                                somaQuantidadeUmidade++;
                            }
                            else if (umidadeAtual > 35 || umidadeAtual < 55) {
                                umidadeIdeal++;
                                somaQuantidadeUmidade++;
                            }
                            porcentagens(); 
                            
                            rosquinha2.data.datasets[0].data = [umidadeIdeal, umidadeAlerta, umidadeEmergencia, umidadeCritica];
                            rosquinha3.data.datasets[0].data = [temperaturaIdeal, temperaturaAlerta, temperaturaEmergencia, temperaturaCritica];

                            rosquinha3.update();
                            rosquinha2.update();
                        }
                    });

                } else {
                    alert("A captura não funcionou")
                    console.log("Houve um erro ao tentar realizar a captura de endereco");
                }

            }).catch(function (erro) {
                console.log(erro);
            })
        }
    }

    function porcentagens() {
        let porcentagemUmiCritica = (umidadeCritica/somaQuantidadeUmidade) * 100;
        pCriticoUmid.innerHTML = `${porcentagemUmiCritica.toFixed(1)}% Crítico`
        
        let porcentagemUmiEmergencia = (umidadeEmergencia/somaQuantidadeUmidade) * 100;
        pEmergenciaUmid.innerHTML = `${porcentagemUmiEmergencia.toFixed(1)}% Emergência`

        let porcentagemUmiAlerta = (umidadeAlerta/somaQuantidadeUmidade) * 100;
        pAlertaUmid.innerHTML = `${porcentagemUmiAlerta.toFixed(1)}% Alerta`
        
        let porcentagemUmiIdeal = (umidadeIdeal/somaQuantidadeUmidade) * 100;
        pIdealUmid.innerHTML = `${porcentagemUmiIdeal.toFixed(1)}% Ideal`
        
        let porcentagemTempCritica = (temperaturaCritica/somaQuantidadeTemperatura) * 100;
        pCriticoTemp.innerHTML = `${porcentagemTempCritica.toFixed(1)}% Crítico`
        
        let porcentagemTempEmergencia = (temperaturaEmergencia/somaQuantidadeTemperatura) * 100;
        pEmergenciaTemp.innerHTML = `${porcentagemTempEmergencia.toFixed(1)}% Emergência`
        
        let porcentagemTempAlerta = (temperaturaAlerta/somaQuantidadeTemperatura) * 100;
        pAlertaTemp.innerHTML = `${porcentagemTempAlerta.toFixed(1)}% Alerta`

        let porcentagemTempIdeal = (temperaturaIdeal/somaQuantidadeTemperatura) * 100;
        pIdealTemp.innerHTML = `${porcentagemTempIdeal.toFixed(1)}% Ideal`


        setTimeout (() => {
            somaQuantidadeTemperatura = 0;
            somaQuantidadeUmidade = 0;
        }, 1000)
        
    }


</script>